<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Allergy Checker</title>
    <style>
        :root { --primary: #2563eb; --danger: #ef4444; --warning: #f59e0b; --success: #10b981; --bg: #f8fafc; }
        body { font-family: sans-serif; background: var(--bg); padding: 15px; margin: 0; }
        .container { max-width: 500px; margin: auto; background: white; padding: 25px; border-radius: 32px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .preview-wrapper { position: relative; width: 100%; aspect-ratio: 1/1; background: #000; border-radius: 24px; overflow: hidden; margin-bottom: 20px; }
        video, #file-preview { width: 100%; height: 100%; object-fit: cover; }
        #loading-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.8); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 10; }
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        button { padding: 16px; border-radius: 16px; border: none; font-weight: bold; cursor: pointer; }
        .btn-capture { background: var(--primary); color: white; grid-column: span 2; }
        .alert-box { padding: 20px; border-radius: 20px; margin-top: 20px; text-align: center; border-top: 8px solid #ccc; }
        .alert-safe { background: #f0fdf4; border-color: var(--success); }
        .alert-critical { background: #fef2f2; border-color: var(--danger); }
        .tag { display: inline-block; padding: 4px 8px; background: rgba(0,0,0,0.1); border-radius: 8px; margin: 2px; font-size: 12px; }
    </style>
</head>
<body>

<div class="container">
    <h3>Allergy Checker</h3>

    <div class="preview-wrapper">
        <div id="loading-overlay"><div>Loading...</div><p id="loading-text"></p></div>
        <video id="video" autoplay playsinline muted></video>
        <img id="file-preview" style="display:none;">
    </div>

    <div class="controls">
        <input type="text" id="my-diet" placeholder="åˆ¶é™ã™ã‚‹æˆåˆ† (ä¾‹: å°éº¦, Peanut)" style="grid-column: span 2; padding:12px; border-radius:12px; border:1px solid #ddd; margin-bottom:10px;">
        <button class="btn-capture" id="btn-scan">ğŸ” ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹ / åˆ¤å®š</button>
        <button id="btn-torch" style="background:#eee;">ğŸ”¦ ãƒ©ã‚¤ãƒˆ</button>
        <button id="btn-file" style="background:#eee;">ğŸ“ å†™çœŸã‚’é¸æŠ</button>
        <input type="file" id="file-input" accept="image/*" style="display:none;">
    </div>

    <div id="result-area"></div>
</div>

<script>
    let stream = null;
    const i18n = { ja: { hold: "å‹•ã‹ã•ãªã„ã§...", analyzing: "AIåˆ†æä¸­..." } };

    // 1. ãƒ©ã‚¤ãƒˆï¼ˆãƒˆãƒ¼ãƒï¼‰åˆ¶å¾¡
    async function toggleTorch() {
        if (!stream) return;
        const track = stream.getVideoTracks()[0];
        const caps = track.getCapabilities();
        if (caps.torch) {
            const settings = track.getSettings();
            await track.applyConstraints({ advanced: [{ torch: !settings.torch }] });
        } else {
            alert("ã“ã®ãƒ‡ãƒã‚¤ã‚¹ã¯ãƒ©ã‚¤ãƒˆåˆ¶å¾¡ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“");
        }
    }

    // 2. ã‚«ãƒ¡ãƒ©é–‹å§‹ã¨åˆ¤å®š
    async function handleScan() {
        if (!stream) {
            stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            document.getElementById('video').srcObject = stream;
        } else {
            capture();
        }
    }

    // 3. ç”»åƒã®ãƒªã‚µã‚¤ã‚ºã¨ã‚­ãƒ£ãƒ—ãƒãƒ£ï¼ˆ500ã‚¨ãƒ©ãƒ¼å¯¾ç­–ï¼‰
    async function capture() {
        document.getElementById('loading-overlay').style.display = "flex";
        document.getElementById('loading-text').innerText = i18n.ja.hold;

        const video = document.getElementById('video');
        const canvas = document.createElement('canvas');

        // Vercelåˆ¶é™å¯¾ç­–: æœ€å¤§å¹…ã‚’1024pxã«ç¸®å°
        const MAX_W = 1024;
        let w = video.videoWidth, h = video.videoHeight;
        if (w > MAX_W) { h *= MAX_W / w; w = MAX_W; }

        canvas.width = w; canvas.height = h;
        canvas.getContext('2d').drawImage(video, 0, 0, w, h);

        const base64 = canvas.toDataURL('image/jpeg', 0.6).split(',')[1];

        // ã‚«ãƒ¡ãƒ©åœæ­¢
        stream.getTracks().forEach(t => t.stop()); stream = null;
        document.getElementById('video').style.display = "none";

        analyze(base64);
    }

    async function analyze(base64) {
        document.getElementById('loading-text').innerText = i18n.ja.analyzing;
        try {
            const res = await fetch('/api/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    imageBase64: base64,
                    myDiet: document.getElementById('my-diet').value,
                    lang: "ja"
                })
            });
            const data = await res.json();
            render(data);
        } catch (e) { alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"); }
        document.getElementById('loading-overlay').style.display = "none";
    }

    function render(res) {
        const isSafe = res.status === "safe";
        document.getElementById('result-area').innerHTML = `
            <div class="alert-box ${isSafe ? 'alert-safe' : 'alert-critical'}">
                <h2>${isSafe ? 'ğŸ˜Š OK' : 'ğŸ˜« NG'}</h2>
                <p><strong>${res.product_name}</strong></p>
                <p>${res.suitability_note}</p>
                <div>${(res.matches || []).map(m => `<span class="tag">${m}</span>`).join('')}</div>
            </div>
        `;
    }

    document.getElementById('btn-scan').onclick = handleScan;
    document.getElementById('btn-torch').onclick = toggleTorch;
    document.getElementById('btn-file').onclick = () => document.getElementById('file-input').click();
    document.getElementById('file-input').onchange = (e) => {
        const reader = new FileReader();
        reader.onload = (ev) => analyze(ev.target.result.split(',')[1]);
        reader.readAsDataURL(e.target.files[0]);
    };
</script>
</body>
</html>